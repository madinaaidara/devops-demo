name: CD (SSH) - Laravel -> Windows Server

on:
  push:
    branches: [main, master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Récupérer le code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Installer PHP + extensions
      - name: Setup PHP
        uses: shivammathur/setup-php@v3
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo_mysql, openssl, pdo

      # 3. Installer les dépendances Composer (production)
      - name: Install Composer dependencies
        run: |
          composer install --no-dev --optimize-autoloader --no-interaction

      # 4. Installer Node.js et construire les assets
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install npm dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      # 5. Préparer le dossier de release (exclure fichiers inutiles)
      - name: Prepare release folder
        run: |
          if [ -d "release" ]; then rm -rf release; fi
          mkdir -p release
          
          # Copier les fichiers nécessaires
          rsync -av \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='tests' \
            --exclude='phpunit.xml' \
            --exclude='.github' \
            . release/
          
          # Réinstaller les dépendances dans le dossier release (sans dev)
          cd release
          composer install --no-dev --optimize-autoloader --no-interaction --no-scripts
          cd ..

      # 6. Créer la clé SSH temporaire
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts || true

      # 7. Upload des fichiers via SCP vers le serveur Windows
      - name: Upload files via SCP
        run: |
          # Créer le dossier staging sur le serveur si nécessaire
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "if (-not (Test-Path 'C:\apps\mon-laravel-staging')) { New-Item -ItemType Directory -Force -Path 'C:\apps\mon-laravel-staging' }"
          
          # Upload des fichiers (format Windows pour SCP)
          scp -i ~/.ssh/deploy_key -r -o StrictHostKeyChecking=no \
            release/* ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:'C:/apps/mon-laravel-staging/'

      # 8. Exécuter les commandes de déploiement sur le serveur Windows
      - name: Remote deploy on Windows Server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            $staging = "C:\apps\mon-laravel-staging"
            $live = "C:\apps\mon-laravel-live"
            
            Write-Host "=== Début du déploiement Laravel ==="
            
            # S'assurer que les dossiers existent
            if (-not (Test-Path $staging)) {
              New-Item -ItemType Directory -Force -Path $staging
            }
            if (-not (Test-Path $live)) {
              New-Item -ItemType Directory -Force -Path $live
            }
            
            # Aller dans le dossier staging
            Set-Location $staging
            
            Write-Host "→ Installation des dépendances Composer..."
            composer install --no-dev --optimize-autoloader --no-interaction
            
            Write-Host "→ Nettoyage du cache Laravel..."
            php artisan cache:clear
            php artisan config:clear
            php artisan route:clear
            php artisan view:clear
            
            Write-Host "→ Cache optimisé..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            Write-Host "→ Exécution des migrations..."
            php artisan migrate --force
            
            # Sauvegarder l'ancienne version live
            if (Test-Path $live) {
              $backupName = $live + "_old_" + (Get-Date -Format "yyyyMMddHHmmss")
              Write-Host "→ Sauvegarde de l'ancienne version vers: $backupName"
              Rename-Item $live $backupName
            }
            
            # Remplacer live par staging
            Write-Host "→ Activation de la nouvelle version..."
            Rename-Item $staging $live
            
            # Aller dans le dossier live (après le rename)
            Set-Location $live
            
            Write-Host "→ Optimisation des permissions Windows..."
            if (Test-Path "$live\storage") {
              icacls "$live\storage" /grant "IUSR:(OI)(CI)(M)" /T
            }
            if (Test-Path "$live\bootstrap\cache") {
              icacls "$live\bootstrap\cache" /grant "IUSR:(OI)(CI)(M)" /T
            }
            
            Write-Host "→ Redémarrage d'IIS (si installé)..."
            if (Get-Service -Name W3SVC -ErrorAction SilentlyContinue) {
              iisreset
            }
            
            Write-Host "=== Déploiement Laravel TERMINÉ ==="

